// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Offre {
  id          Int    @id @default(autoincrement())
  nom         String // nom de l'offre
  prix        Decimal
  description String?
  abonnements Abonnement[]
  createdAt   DateTime @default(now())
}

model Abonnement {
  id        Int      @id @default(autoincrement())
  prix      Decimal  // montant (peut venir de l'offre)
  debut     DateTime
  fin       DateTime

  // Relation avec Offre (remplace l'ancien champ type)
  offreId   Int?
  offre     Offre?   @relation(fields: [offreId], references: [id], onDelete: SetNull)

  // Relation avec User (un user peut avoir plusieurs abonnements, ex. réabonnements)
  userId    Int
  user      User  @relation(fields: [userId], references: [id])
}


model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  password           String
  firstname          String?
  lastname           String?
  role               String?
  activated          Boolean   @default(true)
  phone              String?

  // Lien optionnel vers un éditeur (admin d'éditeur)
  editeurId          Int?
  editeur            Editeur?  @relation(fields: [editeurId], references: [id])

  // Relations avec journaux (Many-to-Many)
  journauxLu           Journal[]  @relation("LuRelation")
  journauxTelecharges  Journal[]  @relation("TelechargeRelation")

  // Lectures (progression de lecture : journal + page)
  lectures             Lecture[]

  // Relation avec abonnements (1–n) : historique des abonnements, un seul "valide" à la fois (fin >= now)
  abonnements   Abonnement[]

  createdAt          DateTime  @default(now())
}

model Editeur {
  id       Int       @id @default(autoincrement())
  nom      String
  journals Journal[] // ← relation un-à-plusieurs
  createdAt DateTime @default(now())
  // Logos (documents)
  documents Document[]

  // Utilisateurs admins liés à cet éditeur
  users    User[]
}

model Journal {
  id                  Int       @id @default(autoincrement())
  title               String
  grosTitre           String?
  // Contenu rédactionnel (hérité de Newsletter)
  content             String?
  // Métadonnées de fichier si applicable
  filename            String
  mime                String
  size                Int
  url                 String?
  dateJournal         DateTime  @default(now())
  
  // Relation père-fils avec User (Many-to-Many) pour lus / téléchargés
  usersLu             User[]    @relation("LuRelation")
  usersTelecharges    User[]    @relation("TelechargeRelation")

  // Relation père-fils avec Editeur
  editeurId           Int
  editeur             Editeur   @relation(fields: [editeurId], references: [id])
  createdAt           DateTime  @default(now())

  // Catégorie (hérité de Newsletter): un journal appartient à une catégorie
  categorieId         Int
  categorie           Categorie @relation(fields: [categorieId], references: [id])

  // Documents (PDFs, page de garde) hérités de Newsletter
  documents           Document[]

  // Lectures utilisateurs (progression par user)
  lectures            Lecture[]
}

model Lecture {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  journalId  Int
  journal    Journal  @relation(fields: [journalId], references: [id], onDelete: Cascade)
  page       Int      @default(1)  // page actuelle
  updatedAt  DateTime @updatedAt

  @@unique([userId, journalId])
}

// Newsletter fusionné dans Journal

model Categorie {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  createdAt   DateTime     @default(now())

  // Newsletters dans cette catégorie
  journals    Journal[]
}

// Type de document stocké
enum DocumentKind {
  NEWSLETTER_PDF       // fichiers PDF d'une newsletter
  NEWSLETTER_COVER     // page de garde d'une newsletter
  EDITEUR_LOGO         // logo d'un éditeur
}

model Document {
  id         Int           @id @default(autoincrement())
  kind       DocumentKind
  url        String        // URL publique/chemin
  filename   String
  mime       String
  size       Int           // en octets
  createdAt  DateTime      @default(now())

  // Rattachements optionnels
  journalId   Int?
  journal     Journal?     @relation(fields: [journalId], references: [id])

  editeurId   Int?
  editeur     Editeur?     @relation(fields: [editeurId], references: [id])
}